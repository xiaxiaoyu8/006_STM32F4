STM32时钟系统详解
引言：为什么时钟如此重要？
在数字电路中，时钟是所有同步操作的“心跳”。对于像STM32这样的微控制器（MCU）来说，时钟系统就是其心脏。它驱动着CPU内核的运行，控制着数据在总线上的传输速度，并为各个外设（如GPIO、UART、ADC等）提供工作所需的频率。

一个正确、稳定、高效的时钟配置，能够：

发挥MCU的最大性能：让CPU运行在允许的最高速度。

实现精准的定时和通信：确保UART、SPI、I2C等通信外设的波特率准确无误。

优化功耗：在不需要高性能时，可以降低时钟频率或关闭未使用外设的时钟，从而显著降低功耗，这对于电池供电的设备尤其重要。

简单来说，如果时钟配置错误，MCU可能无法启动、运行不稳定，或者外设功能不正常。

一、 STM32的五大时钟源
STM32内部有多个时钟源可供选择，以适应不同的应用需求。主要有以下五种：

HSI (High-Speed Internal Clock) - 高速内部时钟

来源：由MCU内部的RC振荡器产生，频率通常为8MHz或16MHz（具体看不同型号的STM32）。

特点：启动速度快，无需外部元件，成本低。但精度和稳定性相对较差，会受温度和电压变化影响。

用途：常作为MCU上电后的默认系统时钟，或在外部晶振（HSE）故障时作为备用时钟（通过时钟安全系统CSS）。

HSE (High-Speed External Clock) - 高速外部时钟

来源：连接到MCU引脚的外部晶体/陶瓷谐振器。频率范围通常在4MHz到26MHz之间（最常见的是8MHz）。

特点：精度高，稳定性好，是获得高性能系统时钟的首选。

用途：通常作为锁相环（PLL）的输入源，倍频后驱动系统时钟（SYSCLK）以达到MCU的最高工作频率（如72MHz或更高）。

LSI (Low-Speed Internal Clock) - 低速内部时钟

来源：内部RC振荡器，频率大约为32kHz（在某些系列中是40kHz）。

特点：功耗极低。精度差，仅用于对精度要求不高的场景。

用途：主要用于驱动独立看门狗（IWDG）和作为RTC（实时时钟）的备用时钟，确保在主时钟关闭的低功耗模式下，这些功能仍能工作。

LSE (Low-Speed External Clock) - 低速外部时钟

来源：连接到MCU引脚的外部低频晶体，频率通常是精准的32.768kHz。

特点：精度非常高，功耗低。

用途：RTC（实时时钟）的最佳时钟源。因为 2 
15
 =32768，这个频率可以非常精确地分频得到1Hz的秒信号。

PLL (Phase-Locked Loop) - 锁相环

来源：它本身不是一个独立的时钟源，而是一个频率倍频器。它可以选择HSI或HSE作为输入时钟。

特点：可以将一个相对较低的输入频率（如8MHz的HSE）倍频到一个很高的频率（如72MHz），作为系统的主时钟。

用途：为系统提供高速时钟，驱动CPU和高速外设。

二、 时钟树（Clock Tree）概览
STM32内部的时钟路径像一棵大树，从时钟源（树根）开始，经过各种选择器（MUX）、分频器（Prescaler），最终将时钟信号（养分）输送到CPU、内存、和各个外设（树枝和树叶）。



blog.csdn.net

这是一个概念图，真实的时钟树在芯片的数据手册中有详细描绘

时钟信号的主要流动路径如下：

选择系统时钟源：首先，通过一个“系统时钟切换器 (System clock mux)”，选择 HSI、HSE 或 PLL 的输出作为 SYSCLK (系统时钟)。

SYSCLK驱动高速总线：SYSCLK 经过一个 AHB预分频器，得到 HCLK 时钟。HCLK直接供给CPU内核、内存和DMA等高速设备。

HCLK驱动低速总线：HCLK再经过 APB1 和 APB2 预分频器，分别得到 PCLK1 和 PCLK2 时钟。

PCLK2 (APB2 Clock): 供给高速外设，如GPIO、ADC、SPI1、TIM1等。其频率通常可以设置得较高。

PCLK1 (APB1 Clock): 供给低速外设，如USART2、I2C1、TIM2等。其最高频率通常有限制（例如，在很多F1系列的MCU上不能超过36MHz）。

三、 核心时钟详解
SYSCLK (System Clock)：系统时钟，是MCU中大部分器件的时钟来源。它的性能直接决定了MCU的运行速度。

HCLK (AHB Bus Clock)：AHB总线时钟，由SYSCLK分频而来。它驱动CPU核心(Cortex-M)、内存(SRAM)、DMA等。通常说的“CPU频率”就是指HCLK。

PCLK1 & PCLK2 (APB Bus Clocks)：APB总线时钟，由HCLK分频而来。它们驱动挂载在APB总线上的外设。

外设定时器的时钟（TIMxCLK）通常是其所在总线时钟（PCLK1或PCLK2）的1倍或2倍，这取决于APB预分频器的设置。

RTC Clock: 由LSE、LSI或HSE分频得到，独立于主时钟系统。

USB Clock: USB外设需要一个非常精确的48MHz时钟，通常由PLL的一个专用输出提供。

四、 外设时钟使能
这是STM32编程中一个非常关键且常见的“坑”。

为了节省功耗，STM32在复位后，默认只开启了最核心部件的时钟，所有外设的时钟都是默认关闭的。因此，在使用任何一个外设（无论是GPIO、UART还是ADC）之前，必须先在RCC（Reset and Clock Control）寄存器中使能它对应的时钟。

例如，要使用GPIOA端口，必须先执行类似以下的代码（以HAL库为例）：
__HAL_RCC_GPIOA_CLK_ENABLE();

如果你发现配置好了某个外设但它完全不工作，首先应该检查是否忘记了开启它的时钟。

五、 时钟配置方法
配置时钟系统通常在system_stm32fxxx.c文件中的SystemInit()函数里完成，这个函数在程序启动时、进入main()函数之前被调用。

配置过程主要包括：

开启并等待外部或内部时钟源稳定（HSE/HSI）。

配置PLL的源、倍频系数、分频系数。

开启PLL并等待其锁定稳定。

配置AHB、APB1、APB2总线的分频系数。

将系统时钟源（SYSCLK）切换到PLL。

配置Flash的读等待周期（LATENCY），因为当CPU频率很高时，Flash的读取速度可能跟不上，需要插入等待周期。

幸运的是，现在我们几乎不需要手动编写这些复杂的代码。

使用STM32CubeMX图形化配置
ST官方提供的STM32CubeMX工具极大地简化了时钟配置。它提供了一个图形化的时钟树配置界面，你只需要：

选择你想要的系统时钟源（如HSE）。

在“HCLK”框中输入你期望的系统频率（如72MHz）。

CubeMX会自动计算并设置所有PLL参数和分频系数，并以红色高亮显示任何不合规的配置。

生成代码后，所有复杂的时钟初始化代码都会被自动放在SystemClock_Config()函数中。

总结
时钟/总线

描述

主要驱动对象

典型频率 (以F103为例)

HSI

高速内部时钟

可作为SYSCLK或PLL源

8 MHz

HSE

高速外部时钟

最佳的PLL时钟源

8 MHz

LSI

低速内部时钟

IWDG, RTC

~40 kHz

LSE

低速外部时钟

RTC

32.768 kHz

PLL

锁相环

产生高速SYSCLK

可达 72 MHz

SYSCLK

系统时钟

MCU的核心时钟

可达 72 MHz

HCLK

AHB总线时钟

CPU, Memory, DMA

可达 72 MHz

PCLK2

APB2总线时钟

GPIO, ADC, TIM1, SPI1

可达 72 MHz

PCLK1

APB1总线时钟

TIM2-7, SPI2, I2C, UARTs

可达 36 MHz

理解STM32的时钟系统是从入门到精通的必经之路。虽然CubeMX等工具让配置变得简单，但深入理解其背后的原理，能帮助你更好地进行系统设计、性能优化和问题调试。